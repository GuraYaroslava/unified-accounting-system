{{define "edit"}}
{{template "header"}}

<div id="container">
	<table id="table-users"></table>
	<div id="table-pager-users"></div>
</div>

<script type="text/javascript">
		$("#logout-btn").css("visibility", "visible");
        var jsData    = "["
        var colNames_ = "{{.ColNames}}".slice(1, -1).split(" ");
        var colModel_ = [];
</script>

<!-- colModel_ init -->
{{with .Columns}}
    {{range $i, $v := .}}
        <script type="text/javascript">
            var data = {};
            function datePicker(e) {$(e).datepicker({"dateFormat":"yy-mm-dd"});}
            data["name"] = "{{$v}}";
            data["index"] = "{{$v}}";
            if ("{{$v}}" == "id" || "{{$v}}" == "login") {
                data["editable"] = false;
            } else if ("{{$v}}" == "date") {
                data["editoptions"] = {dataInit: datePicker}
                data["editable"] = true;
            }else {
                data["editable"] = true;
            }
            colModel_.push(data)
        </script>
    {{end}}
{{end}}
<!-- end colModel_ init -->

{{with .Table}}
    {{range $index, $elmt := .}}
        <script type="text/javascript">
            jsData += "{";
        </script>
        {{range $i, $v := $elmt}}
            {{if $v}}
                <script>jsData += '"' + "{{$i}}" + '"' + ":" + '"' + "{{$v}}" + '"' + ",";</script>
            {{else}}
                <script>jsData += '"' + "{{$i}}" + '"' + ":" + '"' + " " + '"' + ",";</script>
            {{end}}
        {{end}}
        <script type="text/javascript">
            jsData = jsData.slice(0, jsData.length-1) + "},";
        </script>
    {{end}}
    <script type="text/javascript">
        jsData = jsData.slice(0, jsData.length-1) + "]";
    </script>
{{end}}

<script type="text/javascript">
    $(document).ready(function() {
        $("#table-users").jqGrid({
            data:           JSON.parse(jsData),
            datatype:       "local",
            mtype:          "POST",
            treeGrid:       false,
            colNames:       colNames_,
            colModel:       colModel_,
            pager:          $("#table-pager-users"),
            width:          1000,
            height:         "100%",
            rowNum:         10,
            rownumbers:     true,
            rownumWidth:    20,
            caption:        "{{.Caption}}",
            sortname:       "id",
            sortorder:      "asc",
            hoverrows:      true,
            multiselect:    true,
            ondblClickRow:  function(id) {
                                $("#table-users").restoreRow(id);
                                $("#table-users").editRow(id, true);
                            },
            editurl:        "/handler/edit/" + "{{.TableName}}"
        });

        $("#table-users").navGrid(
            "#table-pager-users",
            {
                edit:   true,    edittext:   "Редактировать",
                add:    true,    addtext:    "Создать",
                del:    true,    deltext:    "Удалить",
                view:   false,
                search: false
            },
            { //edit
                //reloadAfterSubmit:  true,
                viewPagerButtons:   false,
                closeAfterEdit:     true,
                afterSubmit:        function(response, postdata) {
                                        window.location.reload();
                                        return [true, "", response.responseText];
                                    }
                
            },
            { //add
                //reloadAfterSubmit:  true,
                viewPagerButtons:   false,
                clearAfterAdd:      true,
                closeAfterAdd:      true,
                addedrow:           "last",
                afterSubmit:        function(response, postdata) {
                                        window.location.reload();
                                        return [true, "", response.responseText];
                                    }
            },
            { //del
                closeAfterAdd:      true,
                viewPagerButtons:   false
            }
        );

        $("#table-users").jqGrid(
            "filterToolbar",
            {
                stringResult:    true,
                searchOnEnter:   false,
                defaultSearch:   "cn"
            }
        );

		$("<p/>", {}).append(
			$("<input/>", {
				type: "button",
				value: "Назад",
				id: "back-btn",
				name: "submit",
			})
		).appendTo("#container");

		$("#back-btn").click(function() {
			history.back();
		});

    });
</script>

{{template "footer"}}
{{end}}
